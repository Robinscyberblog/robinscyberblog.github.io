---
layout: post
title:  "Simple Malware Traffic Analysis with Security Onion"
date:   2021-08-29 16:48:09 -0500
categories: jekyll update
---
Today I am using Security Onion to demostrate a simple malware traffic analysis exercise. I will be using Brad Duncan's website to obtain the packet capture (PCAP) files: [https://www.malware-traffic-analysis.net/](https://www.malware-traffic-analysis.net/). This is a great resource if you are interested in practicing network traffic analysis related to malware.  

To begin, I have downloaded, unzipped and imported a PCAP file into Security Onion using so-import-pcap. There is a password needed to unzip the files, which you can find on the Malware Traffic Analysis website. 

![image](https://user-images.githubusercontent.com/84248865/134733612-a789a3cf-491f-4a37-8f9e-4fcb152ce535.png)

![image](https://user-images.githubusercontent.com/84248865/134733682-f72bd7ec-75a5-4cf8-8204-38ac694d3373.png)

When I launch Security Onion, you'll see below there are some alerts generated by Suricata. Suricata is a threat detection engine that provides intrusion detection, intrusion prevention, and network security monitoring. It uses rules and signatures to monitor network traffic and generate alerts. 

![image](https://user-images.githubusercontent.com/84248865/134733944-4177fa8d-00c1-4793-9cc9-95fefa075368.png)

Next, I'll ungroup these alerts and arrange them in chronological order.

![image](https://user-images.githubusercontent.com/84248865/134734086-2d791ac9-9116-45fe-b61f-53caa6ce1929.png)

With this view, I can see each individual alert, along with the timestamp and the source and destination IP addresses and port numbers. This is useful for quickly identifying each TCP stream that occured during the time frame of this event. I have color coded them below:

![image](https://user-images.githubusercontent.com/84248865/134734154-7771cf7f-28a3-4b40-81be-7fa39c729089.png)

At first glance, there are several areas of interest we will want to investigate, like C2 server connections, HTTP traffic on port 443, a malware checkin response, etc. Before we get ahead of ourselves, let's take a look at the first TCP stream that has occured which starts with "Dotted Quad Host PDF Request." It sounds weird, but dotted quad simply means the decimal representation of an IPv4 address.

![image](https://user-images.githubusercontent.com/84248865/134734464-2c905060-c6c7-41d9-a79c-10e24b96f535.png)

Here we see an HTTP GET request for a PDF file (ooiwy.pdf) coming from 10.8.19.101 and going to 185.244.41.29. Then we see a response from the server, "200 OK", which means the request has succeeded. What's interesting about this is the Content-Type shows application/pdf. However, the file signature mneumonic "MZ" as well as "This program cannot be run in DOS mode" indicates that this is an executable file. It is also strange that the user at the private IP of 10.8.19.101 sent the request to a plain IP address, rather than a domain name.  

Let's invesigate further. Here I've used CyberChef (the chef hat button in the top right corner) to strip the HTTP headers out and just leave the raw file header. 

![image](https://user-images.githubusercontent.com/84248865/134735098-dc38f703-5144-460c-a1c8-ae007004a18f.png)
![image](https://user-images.githubusercontent.com/84248865/134735196-bd49f2f5-87ad-4d6c-8b95-cc5e8b94a6a8.png)

Now, I can generate all available hashes for this file. Hashes are useful for analyzing potentially malicious files because we can run them through a malware detection service such as VirusTotal, and it will tell us if the file has been flagged by various security vendors as malicious. Keep in mind, this is not a foolproof method for identifiying malware. If an attacker realizes that their file is being reported, they can simply change one trivial detail in the file and the hash will be completey different. 

![image](https://user-images.githubusercontent.com/84248865/134735667-e9f3ced0-328b-42f4-b04e-87d111b1fe27.png)

Once we have our hashes, I'm going to take the SHA256 hash and paste it into VirusTotal to see if it detects any malicious content. 

![image](https://user-images.githubusercontent.com/84248865/134735935-1d42f6d1-956a-4e37-89ec-0d86d5ef810f.png)
![image](https://user-images.githubusercontent.com/84248865/134735975-e5c2d0f5-14ab-4b99-ae25-cefb98700373.png)

The results show this file is not trustworthy and has been reported as malicious by 45 out 68 vendors that have scanned it. It appears to be associated with a trojan malware called TrickBot. If we take a look at the Details section, we also find the file types, how old the file is, how recently it's been analyzed, etc. You'll also notice that the PDF file name "ooiwy.pdf" which we saw earlier in our PCAP is also listed.

![image](https://user-images.githubusercontent.com/84248865/134736059-410e488b-7d7d-4ff1-bc43-f0a4a89ab5ac.png)
![image](https://user-images.githubusercontent.com/84248865/134736109-55b4eb57-2150-41c3-ad99-9bc42b6dc7b8.png)

At this point in the investigation, we've discovered that a malicious file disguised as a PDF was downloaded to the machine at 10.8.19.101. Now that the user's machine is compromised, we start to see alerts for C2 server connections and self-signed SSL certificates. This is an indicator that the victim machine is now communicating with an attacker's evil server and the certificates are not signed by a trusted Certificate Authority, meaning you can't really trust that the certificate holder is who they claim to be. 

![image](https://user-images.githubusercontent.com/84248865/134736231-48e05b0c-decc-452f-83dc-c6350805312a.png)

Next, let's look at the PCAP for this connection from the host machine to another external IP address:

![image](https://user-images.githubusercontent.com/84248865/134736421-3d482b25-3513-43f6-9029-9707cc8b6ea3.png)
![image](https://user-images.githubusercontent.com/84248865/134736510-ecc98a1c-9b6c-495d-8040-8a704602dca0.png)

There is an HTTP GET request from the victim machine to api.ipify.org. This site is used to return your own public IP address. You can see the server responded with the IP address 173.66.46.97.

Finally, we arrive at this TCP stream which contains more alerts for suspicious activity. 

![image](https://user-images.githubusercontent.com/84248865/134736611-570800b5-6c23-4526-ac91-30906763f3aa.png)

Here's a first glimpse at the PCAP:

![image](https://user-images.githubusercontent.com/84248865/134736698-1b221665-c44a-4636-b9a1-e04d4f19f6f6.png)

So, we have an HTTP POST request for /rob124/DESKTOP-M1TFHB6_W10019043.0CB9C3AE3FA9B1267DFC20141CDE9D84/90/ over port 443. This is unusual, as port 443 is typically used for encrypted HTTPS traffic. The receiving host is another external IP address of 103.148.41.195. Then, you see a long task list of all the processes running on the victim machine as well as system information.

![image](https://user-images.githubusercontent.com/84248865/134736799-9f2fa6f1-deda-4d2f-8190-023f3d67a0cc.png)
![image](https://user-images.githubusercontent.com/84248865/134736825-c5d1c75c-5817-4cee-a175-8d42ced7b974.png)
![image](https://user-images.githubusercontent.com/84248865/134736863-4dc563a9-7097-4b13-b17d-e4ee2db9e2c2.png)

As you can see, the system info contains sensitive information about the infected machine: the operating system, the host name, the user account name, their IP and MAC address, the domain name, the domain controller...lots of data that may be useful to an attacker. This would be an example of data exfiltration. 

Lastly, we have the server's response, "200 OK", which triggered the alert for the Trickbot Checkin Response. 

![image](https://user-images.githubusercontent.com/84248865/134736957-9526cfc4-b5c3-4ca8-a48a-f5d5b7d34b1d.png)

Now, let's take a step back and look at the big picture of what we've just analyzed. First, we had a suspicious file downloaded by the victim machine which we suspect to be a malicious executable based on the results from VirusTotal. Following the file download, we began to see suspicious traffic to and from external IP addresses presumed to be C2 servers, along with self-signed SSL certificates. Then we noticed a public IP address GET request from the victim machine, followed by a Task List and System POST request that contained information about the victim machine. We have gathered enough information to deem this event a potential security incident and should escalate it to the proper authority. 

Thank you for reading! In addition, thanks to Doug Burks and the Security Onion team for this awesome tool and thanks to Brad Duncan for providing the PCAP exercises! I highly reccommend checking out their sites for some great tutorials and exercises. 



References:

Duncan, Brad. “Malware-Traffic-Analysis.Net.” Malware-Traffic-Analysis.Net, [https://www.malware-traffic-analysis.net/](https://www.malware-traffic-analysis.net/). 

“Magic Bytes – Identifying Common File Formats at a Glance.” NetSPI, 8 July 2013, [https://www.netspi.com/blog/technical/web-application-penetration-testing/magic-bytes-identifying-common-file-formats-at-a-glance/](https://www.netspi.com/blog/technical/web-application-penetration-testing/magic-bytes-identifying-common-file-formats-at-a-glance/). 

Onion, Security. Malware Traffic and CyberChef Magic - 2021-08-19. YouTube, 27 Aug. 2021, [https://www.youtube.com/watch?v=dF2zWBO-Dgc](https://www.youtube.com/watch?v=dF2zWBO-Dgc).

“Security Onion Documentation — Security Onion 2.3 Documentation.” Security Onion Documentation — Security Onion 2.3 Documentation, [https://docs.securityonion.net/en/2.3/](https://docs.securityonion.net/en/2.3/). 

Techopedia. “Dotted Quad - Definition from Techopedia.” Techopedia.Com, Techopedia, 15 Nov. 2016, [https://www.techopedia.com/definition/6899/dotted-quad](https://www.techopedia.com/definition/6899/dotted-quad).

“TrickBot Malware CISA.” Homepage CISA, [https://us-cert.cisa.gov/ncas/alerts/aa21-076a](https://us-cert.cisa.gov/ncas/alerts/aa21-076a). 

“VirusTotal.” VirusTotal, [https://www.virustotal.com/gui/home/search](https://www.virustotal.com/gui/home/search). 


